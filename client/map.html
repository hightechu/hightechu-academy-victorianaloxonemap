<!doctype html>
<html lang="en">
  <!-- HEAD -->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- ADD TITLE -->
    <title></title>
    <!-- ADD DESCRIPTION -->
    <meta name="description" content="">
    <!-- ADD AUTHOR -->
    <meta name="author" content="">
    <!-- ADD CSS FILES HERE -->
    <link rel='icon' href='/img/favicon.ico' type='image/x-icon'>
    <link rel="stylesheet" href="css/styles.css">

    <meta charset="utf-8" />
    <title>Leaflet Routing Machine Example</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="leaflet-routing-machine.css" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
    crossorigin=""/>

    <style>
      .map {
        position: absolute;
        width: 100%;
        height: 100%;
      }
    </style>

    <!-- ADD FAVICON -->
    <!-- Learn more about favicons here: https://en.wikipedia.org/wiki/Favicon -->
  </head>
  <!-- BODY -->
  <body>
    <div class="progress">
      <div class="progress-bar" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
    </div>
    <!-- ADD CONTENT HERE -->
    <body onload="getLocation()"></body>

    <section>
      <div>
        <a href = "/Step2.html" class="button"> Back to previous page</a>
        <a href = "/" class="button"> Back to homepage</a>

        <button onClick = "getKits()" class="button"> Show kits</button>
        <button onClick = "getLocation()" class="button"> Reset</button>
      
      </div>
    </section>

    <div id="map" class="map"></div>
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
            integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
            crossorigin=""></script>
    <script src="js/leaflet-routing-machine.js"></script>

    <br>

    <div class="outerdiv" width="100%">
      <div class="innerdiv" id="mapid"></div>
    </div> 

    <!-- JAVASCRIPT SCRIPT -->
    <!-- ADD JS FILES HERE -->
    <script>
      function getLocation() 
      {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition);
          
        } else {
          //x.innerHTML = "Geolocation is not supported by this browser.";
        }
      }
      function showPosition(position) 
      {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

        var closestLat;
        var closestLon;

        responseStatus = function (response, status) 
        {
          var currentBest = 100000000000000000000000;

          if(response.length == 0) return;

          for(var i = 0; i < response.length; i++)
          {
            var dist = findDist(response[i].latitude, response[i].longitude, lat, lon);
            console.log(dist + " " + response[i].name);

            var marker = L.marker([response[i].latitude, response[i].longitude]).addTo(mymap);
            
            if(dist < currentBest)
            {
              currentBest = dist;
              closestLat = response[i].latitude;
              closestLon = response[i].longitude;
            }
            
          }
          L.Routing.control({
          waypoints: [
          L.latLng(closestLat, closestLon),
          L.latLng(lat, lon)
          ],
          routeWhileDragging: true,
          draggableWaypoints: false
          }).addTo(mymap);
        }
        
        // Connect to the API
        connectAPI("kits", "GET", responseStatus);
    }

    function findDist(lat1,lon1,lat2,lon2) 
    {
      var R = 6371; // Radius of the earth in km
      var dLat = deg2rad(lat2-lat1);  // deg2rad below
      var dLon = deg2rad(lon2-lon1); 
      var a = 
      Math.sin(dLat/2) * Math.sin(dLat/2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
      Math.sin(dLon/2) * Math.sin(dLon/2); 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c; // Distance in km
      return d;
    }

    function deg2rad(deg) 
    {
      return deg * (Math.PI/180)
    }




      </script>
    <script src="js/helper.js"></script> <!-- Loopback JavaScript Helper-->
    <script src="js/main.js"></script>
    <script src="js/getKits.js"></script>
  </body>
</html>
